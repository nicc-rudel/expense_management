<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestore Spese</title>
    
    <!-- --- CONFIGURAZIONE WEB APP (ICONA & FULLSCREEN) --- -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Spese Pro">
    
    <!-- Icona generata via SVG -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232563eb%22 rx=%2220%22 ry=%2220%22/><text x=%2250%22 y=%2250%22 font-size=%2260%22 text-anchor=%22middle%22 dy=%22.35em%22>üí∞</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease-out; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

<div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-gray-50 shadow-2xl relative">

    <!-- HEADER -->
    <header class="bg-white p-4 shadow-sm z-10 flex justify-between items-center flex-shrink-0 pt-safe-top">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white border border-gray-200 rounded-xl flex items-center justify-center text-gray-600 shadow-sm cursor-pointer hover:bg-gray-50 active:scale-95 transition"
                 @click="mostraMenu = true">
                <i class="fa-solid fa-bars text-lg"></i>
            </div>
            <div>
                <h1 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Saldo Attuale</h1>
                <div class="text-xl font-extrabold leading-none tracking-tight" :class="saldoTotale >= 0 ? 'text-gray-800' : 'text-red-500'">
                    {{ formatValuta(saldoTotale) }}
                </div>
            </div>
        </div>
        <div class="flex gap-3">
            <div class="text-right">
                <div class="text-[10px] text-gray-400 uppercase font-bold">Entrate</div>
                <div class="text-green-600 font-bold text-xs">+{{ formatValutaNoSymbol(totaleEntrate) }}</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-gray-400 uppercase font-bold">Uscite</div>
                <div class="text-red-500 font-bold text-xs">-{{ formatValutaNoSymbol(totaleUscite) }}</div>
            </div>
        </div>
    </header>

    <!-- LISTA TRANSAZIONI -->
    <main class="flex-1 overflow-y-auto p-4 pb-24 space-y-4">
        <div v-if="transazioni.length === 0" class="flex flex-col items-center justify-center h-64 text-gray-400">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <i class="fa-solid fa-wallet text-3xl opacity-20"></i>
            </div>
            <p class="font-medium">Nessuna spesa presente</p>
        </div>

        <div v-for="(gruppo, mese) in transazioniPerMese" :key="mese" class="bg-white rounded-2xl shadow-sm overflow-hidden animate-fade-in border border-gray-100">
            <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center sticky top-0 z-0">
                <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider">{{ mese }}</h3>
                <span class="text-xs font-mono font-bold px-2 py-0.5 rounded bg-white border border-gray-200"
                    :class="calcolaTotaleMese(gruppo) >= 0 ? 'text-green-600' : 'text-red-500'">
                    {{ calcolaTotaleMese(gruppo) >= 0 ? '+' : '' }}{{ formatValutaNoSymbol(calcolaTotaleMese(gruppo)) }}‚Ç¨
                </span>
            </div>
            <ul>
                <li v-for="t in gruppo" :key="t.id" @click="apriModifica(t)" class="p-4 border-b last:border-0 flex justify-between items-center active:bg-gray-50 transition group cursor-pointer relative">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-white text-lg shadow-sm overflow-hidden transform transition group-active:scale-95"
                            :style="{ backgroundColor: t.tipo === 'entrata' ? '#10B981' : getColorCategoria(t.categoria) }">
                            <i v-if="isFaIcon(getIcona(t.categoria))" :class="getIcona(t.categoria)"></i>
                            <span v-else class="text-xl leading-none pt-1">{{ getIcona(t.categoria) }}</span>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 leading-tight text-sm">{{ t.descrizione }}</p>
                            <p class="text-[11px] text-gray-400 mt-0.5 font-medium">{{ t.data_short }} ‚Ä¢ {{ t.categoria }}</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="font-bold font-mono text-base" :class="t.tipo === 'entrata' ? 'text-green-600' : 'text-gray-800'">
                            {{ t.tipo === 'entrata' ? '+' : '-' }}{{ formatValutaNoSymbol(t.importo) }}
                        </span>
                        <button @click.stop="eliminaTransazione(t.id)" class="relative z-20 text-gray-300 text-[10px] mt-1 hover:text-red-500 p-2 -mr-2 flex items-center gap-1">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </li>
            </ul>
        </div>
    </main>

    <!-- FAB -->
    <button @click="apriFormNuovaSpesa" class="absolute bottom-6 right-6 w-14 h-14 bg-gray-900 text-white rounded-2xl shadow-xl flex items-center justify-center text-2xl hover:bg-black hover:scale-105 active:scale-95 transition transform z-20">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- SIDEBAR MENU -->
    <div v-if="mostraMenu" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex justify-start transition-opacity backdrop-blur-sm" @click.self="mostraMenu = false">
        <div class="w-80 bg-white h-full shadow-2xl flex flex-col animate-slide-in-left">
            <div class="p-5 pb-0 flex justify-between items-center">
                <h2 class="font-bold text-xl text-gray-800">Menu</h2>
                <button @click="mostraMenu = false" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="px-5 mt-6 mb-2">
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button @click="tabMenu = 'analisi'" class="flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2" :class="tabMenu === 'analisi' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-400 hover:text-gray-600'">
                        <i class="fa-solid fa-chart-pie"></i> Analisi
                    </button>
                    <button @click="tabMenu = 'categorie'" class="flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2" :class="tabMenu === 'categorie' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-400 hover:text-gray-600'">
                        <i class="fa-solid fa-list"></i> Categorie
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pt-2">
                
                <!-- TAB ANALISI -->
                <div v-if="tabMenu === 'analisi'" class="space-y-6 animate-fade-in">
                    
                    <!-- Switch Grafico Entrate/Uscite -->
                    <div class="flex justify-center mb-2">
                        <div class="bg-gray-100 p-1 rounded-lg flex text-xs font-bold">
                            <button @click="vistaGrafico = 'uscita'" class="px-4 py-2 rounded-md transition" :class="vistaGrafico === 'uscita' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-400 hover:text-gray-600'">USCITE</button>
                            <button @click="vistaGrafico = 'entrata'" class="px-4 py-2 rounded-md transition" :class="vistaGrafico === 'entrata' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'">ENTRATE</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm text-center">
                         <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-6">
                            {{ vistaGrafico === 'uscita' ? 'Dove spendi i tuoi soldi' : 'Provenienza Entrate' }}
                         </h3>
                         
                         <div v-if="totaleVisualizzato > 0">
                            <div class="relative w-48 h-48 mx-auto rounded-full mb-6" :style="stileGrafico">
                                <div class="absolute inset-0 m-auto w-28 h-28 bg-white rounded-full flex flex-col items-center justify-center shadow-inner">
                                    <span class="text-[10px] text-gray-400 uppercase font-bold">{{ vistaGrafico === 'uscita' ? 'Uscite' : 'Entrate' }}</span>
                                    <span class="font-bold text-gray-800 text-lg">{{ formatValutaNoSymbol(totaleVisualizzato) }}‚Ç¨</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div v-for="stat in statisticheCategorie" :key="stat.cat" class="flex justify-between items-center text-sm group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-8 rounded-full" :style="{ backgroundColor: stat.colore }"></div>
                                        <div class="text-left">
                                            <div class="font-bold text-gray-700">{{ stat.cat }}</div>
                                            <div class="text-xs text-gray-400">{{ formatValutaNoSymbol(stat.val) }}‚Ç¨</div>
                                        </div>
                                    </div>
                                    <div class="font-mono font-bold text-gray-600 bg-gray-50 px-2 py-1 rounded">{{ stat.perc }}%</div>
                                </div>
                            </div>
                         </div>
                         <div v-else class="py-10 text-gray-400 text-sm">
                             <i class="fa-solid fa-chart-simple text-3xl mb-2 opacity-30 block"></i>
                             Nessun dato presente.
                         </div>
                    </div>
                </div>

                <!-- TAB CATEGORIE -->
                <div v-if="tabMenu === 'categorie'" class="space-y-6 animate-fade-in">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Crea Nuova Categoria</label>
                        <div class="flex gap-2 mb-3">
                            <div class="w-1/3 relative">
                                <input v-model="nuovaCatIcona" placeholder="üé®" class="w-full h-11 text-center text-xl border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-800 outline-none bg-white shadow-sm" maxlength="2">
                                <span class="text-[9px] text-gray-400 text-center block mt-1 absolute -bottom-4 w-full">Emoji</span>
                            </div>
                            <div class="w-2/3">
                                <input v-model="nuovaCatNome" placeholder="Nome (es. Netflix)" class="w-full h-11 px-3 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-800 outline-none bg-white shadow-sm">
                            </div>
                        </div>
                        <button @click="creaCategoria" class="w-full py-2.5 bg-gray-800 text-white text-xs font-bold rounded-lg hover:bg-black transition shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Aggiungi
                        </button>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-1">Categorie Attive</h3>
                        <div class="space-y-2">
                            <div v-for="(cat, index) in categorie" :key="index" class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-gray-50 flex items-center justify-center text-lg">
                                        <i v-if="isFaIcon(cat.icona)" :class="cat.icona" class="text-gray-500 text-sm"></i>
                                        <span v-else class="leading-none pt-0.5">{{ cat.icona }}</span>
                                    </div>
                                    <span class="font-bold text-sm text-gray-700">{{ cat.nome }}</span>
                                </div>
                                <button @click="eliminaCategoria(index)" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition" v-if="categorie.length > 1">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 text-center text-xs text-gray-400">Gestore Spese v2.0</div>
        </div>
    </div>

    <!-- MODALE TRANSAZIONE -->
    <transition name="slide-up">
        <div v-if="mostraForm" class="fixed inset-0 z-40 flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-gray-900 bg-opacity-60 pointer-events-auto backdrop-blur-sm" @click="chiudiForm"></div>
            <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-2xl p-6 pb-10 shadow-2xl transform transition-transform pointer-events-auto max-h-[90vh] overflow-y-auto">
                <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-center text-sm font-bold text-gray-400 uppercase tracking-widest mb-6">
                    {{ idModifica ? 'Modifica' : 'Nuova' }} 
                    <span :class="nuova.tipo === 'entrata' ? 'text-green-600' : 'text-red-500'">
                        {{ nuova.tipo === 'entrata' ? 'Entrata' : 'Spesa' }}
                    </span>
                </h3>

                <form @submit.prevent="salvaTransazione">
                    <div class="flex bg-gray-100 p-1 rounded-xl mb-8">
                        <button type="button" @click="nuova.tipo = 'uscita'" class="flex-1 py-3 rounded-lg font-bold text-sm transition" :class="nuova.tipo === 'uscita' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-400'">USCITA</button>
                        <button type="button" @click="nuova.tipo = 'entrata'" class="flex-1 py-3 rounded-lg font-bold text-sm transition" :class="nuova.tipo === 'entrata' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-400'">ENTRATA</button>
                    </div>

                    <div class="mb-8 text-center">
                        <label class="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wider">Importo</label>
                        <div class="relative inline-block">
                            <input type="number" step="0.01" inputmode="decimal" required v-model.number="nuova.importo" placeholder="0.00" autoFocus class="w-full bg-transparent text-6xl font-extrabold text-center text-gray-800 focus:outline-none placeholder-gray-200 p-2">
                            <span class="absolute -right-6 top-4 text-2xl text-gray-400 font-bold">‚Ç¨</span>
                        </div>
                    </div>

                    <!-- CAMPI VISIBILI SOLO SE √à USCITA OPPURE SE STIAMO MODIFICANDO (Per poter categorizzare entrate) -->
                    <div v-if="nuova.tipo === 'uscita' || idModifica" class="animate-fade-in">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">Descrizione</label>
                                <input type="text" v-model="nuova.descrizione" placeholder="Es. Stipendio" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm font-medium focus:ring-2 focus:ring-gray-800 outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">Data</label>
                                <input type="date" v-model="nuova.data" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm font-medium focus:ring-2 focus:ring-gray-800 outline-none">
                            </div>
                        </div>

                        <div class="mb-8">
                            <label class="text-[10px] font-bold text-gray-400 mb-3 block uppercase flex justify-between items-center">
                                Categoria
                                <span v-if="mostraFormCategoriaVeloce" class="text-gray-800 text-xs normal-case bg-gray-100 px-2 py-0.5 rounded">Nuova Categoria</span>
                            </label>
                            
                            <!-- Crea Categoria Veloce -->
                            <div v-if="mostraFormCategoriaVeloce" class="mb-4 bg-gray-50 p-3 rounded-xl border border-blue-100 animate-fade-in">
                                <div class="flex gap-2">
                                    <div class="w-1/4 relative">
                                        <input v-model="nuovaCatIconaVeloce" placeholder="üé®" class="w-full h-10 text-center text-lg border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white" maxlength="2">
                                    </div>
                                    <div class="w-3/4">
                                        <input v-model="nuovaCatNomeVeloce" placeholder="Nome Categoria..." class="w-full h-10 px-3 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button type="button" @click="mostraFormCategoriaVeloce = false" class="flex-1 py-1.5 bg-gray-200 text-gray-600 text-xs font-bold rounded-lg">Annulla</button>
                                    <button type="button" @click="creaCategoriaVeloce" class="flex-1 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700">Crea & Usa</button>
                                </div>
                            </div>

                            <!-- Lista Categorie -->
                            <div class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide -mx-2 px-2">
                                <div v-for="cat in categorie" :key="cat.nome" @click="nuova.categoria = cat.nome" class="flex flex-col items-center gap-2 cursor-pointer min-w-[70px]">
                                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-xl transition border-2" :class="nuova.categoria === cat.nome ? 'bg-gray-800 text-white border-gray-800 shadow-lg scale-110' : 'bg-white text-gray-400 border-gray-100 hover:border-gray-200'">
                                        <i v-if="isFaIcon(cat.icona)" :class="cat.icona"></i>
                                        <span v-else class="text-2xl pt-1 leading-none">{{ cat.icona }}</span>
                                    </div>
                                    <span class="text-[10px] font-bold truncate w-full text-center" :class="nuova.categoria === cat.nome ? 'text-gray-800' : 'text-gray-300'">{{ cat.nome }}</span>
                                </div>
                                <div @click="mostraFormCategoriaVeloce = !mostraFormCategoriaVeloce" class="flex flex-col items-center gap-2 cursor-pointer min-w-[70px]">
                                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-xl transition border-2 bg-blue-50 text-blue-600 border-blue-100 hover:bg-blue-100">
                                        <i class="fa-solid fa-plus"></i>
                                    </div>
                                    <span class="text-[10px] font-bold truncate w-full text-center text-blue-600">Crea</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-4 bg-gray-900 text-white text-lg font-bold rounded-2xl shadow-xl hover:bg-black active:scale-95 transition flex items-center justify-center gap-2">
                        <span>{{ idModifica ? 'Salva Modifiche' : 'Conferma' }}</span> 
                        <i class="fa-solid" :class="idModifica ? 'fa-floppy-disk' : 'fa-check'"></i>
                    </button>
                </form>
            </div>
        </div>
    </transition>

    <!-- MODALE CONFERMA -->
    <transition name="fade">
        <div v-if="mostraModalConferma" class="fixed inset-0 z-50 flex items-center justify-center">
            <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm" @click="mostraModalConferma = false"></div>
            <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl transform transition-all scale-100 relative z-10 text-center">
                <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-trash"></i></div>
                <h3 class="font-bold text-lg text-gray-800 mb-2">Eliminare la spesa?</h3>
                <p class="text-sm text-gray-500 mb-6">Questa azione non pu√≤ essere annullata.</p>
                <div class="flex gap-3">
                    <button @click="mostraModalConferma = false" class="flex-1 py-2.5 bg-gray-200 text-gray-700 font-bold rounded-xl text-sm">Annulla</button>
                    <button @click="procediEliminazione" class="flex-1 py-2.5 bg-red-500 text-white font-bold rounded-xl text-sm hover:bg-red-600">Elimina</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp } = Vue;
    createApp({
        data() {
            return {
                mostraMenu: false,
                tabMenu: 'analisi',
                vistaGrafico: 'uscita', // 'uscita' | 'entrata'
                mostraForm: false,
                idModifica: null,
                mostraModalConferma: false,
                idDaEliminare: null,
                mostraFormCategoriaVeloce: false,
                nuovaCatNomeVeloce: '', nuovaCatIconaVeloce: '',
                nuovaCatNome: '', nuovaCatIcona: '',
                categorie: [
                    { nome: 'Casa', icona: 'üè†' }, { nome: 'Cibo', icona: 'üçî' }, { nome: 'Auto', icona: 'üöó' },
                    { nome: 'Shopping', icona: 'üõçÔ∏è' }, { nome: 'Svago', icona: 'üéÆ' }, { nome: 'Salute', icona: 'üíä' },
                    { nome: 'Stipendio', icona: 'üí∞' }, { nome: 'Regalo', icona: 'üéÅ' }
                ],
                nuova: { tipo: 'uscita', importo: '', descrizione: '', categoria: 'Cibo', data: new Date().toISOString().split('T')[0] },
                transazioni: [],
                paletteColori: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316']
            }
        },
        computed: {
            saldoTotale() { return this.transazioni.reduce((acc, t) => t.tipo === 'entrata' ? acc + t.importo : acc - t.importo, 0); },
            totaleEntrate() { return this.transazioni.filter(t => t.tipo === 'entrata').reduce((acc, t) => acc + t.importo, 0); },
            totaleUscite() { return this.transazioni.filter(t => t.tipo === 'uscita').reduce((acc, t) => acc + t.importo, 0); },
            totaleVisualizzato() {
                // Calcola il totale per il grafico (entrate o uscite)
                return this.transazioni.filter(t => t.tipo === this.vistaGrafico).reduce((acc, t) => acc + t.importo, 0);
            },
            transazioniPerMese() {
                const gruppi = {};
                const ordinate = [...this.transazioni].sort((a, b) => new Date(b.data) - new Date(a.data));
                ordinate.forEach(t => {
                    const data = new Date(t.data);
                    const chiaveMese = data.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
                    t.data_short = data.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
                    if (!gruppi[chiaveMese]) gruppi[chiaveMese] = [];
                    gruppi[chiaveMese].push(t);
                });
                return gruppi;
            },
            statisticheCategorie() {
                // Filtra in base a vistaGrafico (uscita o entrata)
                const filtrate = this.transazioni.filter(t => t.tipo === this.vistaGrafico);
                if (filtrate.length === 0) return [];
                const tot = filtrate.reduce((acc, t) => acc + t.importo, 0);
                const stats = {};
                filtrate.forEach(t => {
                    if(!stats[t.categoria]) {
                        stats[t.categoria] = { cat: t.categoria, val: 0, colore: this.getColorCategoria(t.categoria) };
                    }
                    stats[t.categoria].val += t.importo;
                });
                return Object.values(stats).sort((a, b) => b.val - a.val).map(s => ({ ...s, perc: ((s.val / tot) * 100).toFixed(1) }));
            },
            stileGrafico() {
                const stats = this.statisticheCategorie;
                if (!stats.length) return { background: '#eee' };
                let gradient = ''; let current = 0;
                stats.forEach((s, i) => {
                    const start = current;
                    const end = current + parseFloat(s.perc);
                    gradient += `${s.colore} ${start}% ${end}%${i < stats.length - 1 ? ', ' : ''}`;
                    current = end;
                });
                return { background: `conic-gradient(${gradient})` };
            }
        },
        methods: {
            apriFormNuovaSpesa() {
                this.idModifica = null; this.mostraForm = true; this.mostraFormCategoriaVeloce = false;
                this.nuova = { tipo: 'uscita', importo: '', descrizione: '', categoria: 'Cibo', data: new Date().toISOString().split('T')[0] };
            },
            apriModifica(transazione) {
                this.idModifica = transazione.id; this.mostraForm = true; this.mostraFormCategoriaVeloce = false;
                this.nuova = JSON.parse(JSON.stringify(transazione));
            },
            chiudiForm() { this.mostraForm = false; this.idModifica = null; this.mostraFormCategoriaVeloce = false; },
            salvaTransazione() {
                // Se √® NUOVA Entrata (non modifica), resetta descr/cat
                if (this.nuova.tipo === 'entrata' && !this.idModifica) {
                    if(this.nuova.importo <= 0) return;
                    this.nuova.descrizione = 'Entrata';
                    this.nuova.categoria = 'Entrata';
                } else {
                    if(this.nuova.importo <= 0 || !this.nuova.descrizione) return;
                }
                const dati = { ...this.nuova, importo: parseFloat(this.nuova.importo) };
                if (this.idModifica) {
                    const index = this.transazioni.findIndex(t => t.id === this.idModifica);
                    if (index !== -1) this.transazioni[index] = { ...dati, id: this.idModifica };
                } else {
                    this.transazioni.unshift({ id: Date.now(), ...dati });
                }
                this.salvaDati(); this.chiudiForm();
            },
            eliminaTransazione(id) { this.idDaEliminare = id; this.mostraModalConferma = true; },
            procediEliminazione() {
                if (this.idDaEliminare) { this.transazioni = this.transazioni.filter(t => t.id !== this.idDaEliminare); this.salvaDati(); }
                this.mostraModalConferma = false; this.idDaEliminare = null;
            },
            creaCategoria() {
                if(this.nuovaCatNome && !this.categorie.find(c => c.nome === this.nuovaCatNome)) {
                    this.categorie.push({ nome: this.nuovaCatNome, icona: this.nuovaCatIcona.trim() || 'üè∑Ô∏è' });
                    this.nuovaCatNome = ''; this.nuovaCatIcona = ''; this.salvaDati();
                }
            },
            creaCategoriaVeloce() {
                if(this.nuovaCatNomeVeloce && !this.categorie.find(c => c.nome === this.nuovaCatNomeVeloce)) {
                    this.categorie.push({ nome: this.nuovaCatNomeVeloce, icona: this.nuovaCatIconaVeloce.trim() || 'üè∑Ô∏è' });
                    this.nuova.categoria = this.nuovaCatNomeVeloce; this.nuovaCatNomeVeloce = ''; this.nuovaCatIconaVeloce = ''; this.mostraFormCategoriaVeloce = false; this.salvaDati();
                }
            },
            eliminaCategoria(index) { if(confirm('Eliminare categoria?')) { this.categorie.splice(index, 1); this.salvaDati(); } },
            getIcona(nomeCategoria) {
                if (nomeCategoria === 'Entrata') return 'üí∞';
                const cat = this.categorie.find(c => c.nome === nomeCategoria);
                return cat ? cat.icona : 'üè∑Ô∏è';
            },
            isFaIcon(icon) { return icon && icon.toString().startsWith('fa-'); },
            getColorCategoria(nome) {
                let hash = 0; for (let i = 0; i < nome.length; i++) hash = nome.charCodeAt(i) + ((hash << 5) - hash);
                return this.paletteColori[Math.abs(hash) % this.paletteColori.length];
            },
            calcolaTotaleMese(gruppo) { return gruppo.reduce((acc, t) => t.tipo === 'entrata' ? acc + t.importo : acc - t.importo, 0); },
            formatValuta(val) { return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val); },
            formatValutaNoSymbol(val) { return new Intl.NumberFormat('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val); },
            salvaDati() { localStorage.setItem('wallet_transazioni', JSON.stringify(this.transazioni)); localStorage.setItem('wallet_categorie_obj', JSON.stringify(this.categorie)); },
            caricaDati() {
                const tx = localStorage.getItem('wallet_transazioni'); const catObj = localStorage.getItem('wallet_categorie_obj');
                if (tx) this.transazioni = JSON.parse(tx); if (catObj) this.categorie = JSON.parse(catObj);
            }
        },
        mounted() { this.caricaDati(); }
    }).mount('#app');
</script>
</body>
</html>
